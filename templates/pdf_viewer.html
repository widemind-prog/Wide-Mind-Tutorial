<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>PDF Viewer</title>

  <style>
    body {
      margin: 0;
      background: #111;
      color: #fff;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #controls {
      width: 100%;
      padding: 10px;
      background: #000;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    #closeBtn {
      position: absolute;
      right: 15px;
      top: 10px;
      background: transparent;
      color: #fff;
      font-size: 22px;
      border: none;
      cursor: pointer;
    }

    #closeBtn:hover { color: #ff4d4d; }

    button {
      padding: 6px 12px;
      border: none;
      cursor: pointer;
      background: #444;
      color: #fff;
    }

    button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    canvas#pdfCanvas {
      margin: 20px auto;
      background: #fff;
      max-width: 95%;
      height: auto;
      position: relative;
    }

    #thumbnailsWrapper {
      display: flex;
      align-items: center;
      width: 95%;
      background: #222;
      padding: 10px;
      gap: 5px;
      overflow: hidden;
    }

    #thumbnails {
      display: flex;
      overflow-x: auto;
      gap: 6px;
      scroll-behavior: smooth;
    }

    #thumbnails canvas {
      width: 60px;
      cursor: pointer;
      border: 2px solid #555;
      flex-shrink: 0;
      transition: border 0.2s;
    }

    #thumbnails canvas.active {
      border-color: #ff4d4d;
    }

    .thumbArrow {
      background: #333;
      color: #fff;
      border: none;
      cursor: pointer;
      padding: 5px 10px;
      font-size: 20px;
    }

    .thumbArrow:hover {
      background: #555;
    }
  </style>
</head>

<body>

<div id="controls">
  <button id="prevBtn">Previous</button>
  <span id="pageInfo">Page 1 of 1</span>
  <button id="nextBtn">Next</button>
  <button id="closeBtn" title="Close PDF">&times;</button>
</div>

<canvas id="pdfCanvas"></canvas>

<div id="thumbnailsWrapper">
  <button class="thumbArrow" id="thumbLeft">&#10094;</button>
  <div id="thumbnails"></div>
  <button class="thumbArrow" id="thumbRight">&#10095;</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<script>
/* ===== CONFIG ===== */
const pdfUrl = "/stream/pdf/{{ material_id }}";
const username = "{{ username|e }}"; // Escaped for JS
const courseUrl = "/course/{{ course_id }}"; // redirect target for close button

pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

/* ===== STATE ===== */
let pdfDoc = null;
let pageNum = 1;
let totalPages = 0;
const pageCache = {}; // store rendered pages as images

/* ===== ELEMENTS ===== */
const canvas = document.getElementById("pdfCanvas");
const ctx = canvas.getContext("2d");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const pageInfo = document.getElementById("pageInfo");
const closeBtn = document.getElementById("closeBtn");
const thumbnailsContainer = document.getElementById("thumbnails");
const thumbLeft = document.getElementById("thumbLeft");
const thumbRight = document.getElementById("thumbRight");

/* ===== LOAD PDF ===== */
pdfjsLib.getDocument(pdfUrl).promise
  .then(pdf => {
    pdfDoc = pdf;
    totalPages = pdf.numPages;
    updateUI(pageNum); // display total pages immediately
    renderPage(pageNum);
    createThumbnails();
  })
  .catch(err => {
    console.error("PDF load error:", err);
    pageInfo.textContent = "Failed to load PDF";
  });

/* ===== RENDER PAGE ===== */
function renderPage(num) {
  if (!pdfDoc) return;

  if (pageCache[num]) {
    const img = new Image();
    img.onload = () => {
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(img, 0, 0);
      drawWatermark();
      updateUI(num);
    };
    img.src = pageCache[num];
    return;
  }

  pdfDoc.getPage(num).then(page => {
    const scale = 1.2;
    const viewport = page.getViewport({ scale });
    canvas.width = viewport.width;
    canvas.height = viewport.height;

    page.render({ canvasContext: ctx, viewport }).promise.then(() => {
      pageCache[num] = canvas.toDataURL();
      drawWatermark();
      updateUI(num);
      preloadAdjacentPages(num);
    });
  });
}

/* ===== DRAW WATERMARK ===== */
function drawWatermark() {
  const text = `${username} Â· ${new Date().toLocaleString()}`;
  ctx.save();
  ctx.font = "16px Arial";
  ctx.fillStyle = "rgba(255,255,255,0.15)";
  ctx.rotate(-0.3);
  ctx.textAlign = "left";
  ctx.textBaseline = "middle";

  const stepX = 200;
  const stepY = 150;

  for (let x = 0; x < canvas.width; x += stepX) {
    for (let y = 0; y < canvas.height; y += stepY) {
      ctx.fillText(text, x, y);
    }
  }
  ctx.restore();
}

/* ===== PRELOAD ADJACENT PAGES ===== */
function preloadAdjacentPages(current) {
  [current + 1, current - 1].forEach(n => {
    if (n >= 1 && n <= totalPages && !pageCache[n]) {
      pdfDoc.getPage(n).then(page => {
        const viewport = page.getViewport({ scale: 0.6 });
        const tempCanvas = document.createElement("canvas");
        tempCanvas.width = viewport.width;
        tempCanvas.height = viewport.height;
        page.render({ canvasContext: tempCanvas.getContext("2d"), viewport }).promise
          .then(() => pageCache[n] = tempCanvas.toDataURL());
      });
    }
  });
}

/* ===== THUMBNAILS ===== */
function createThumbnails() {
  for (let i = 1; i <= totalPages; i++) {
    const thumbCanvas = document.createElement("canvas");
    const thumbCtx = thumbCanvas.getContext("2d");
    thumbnailsContainer.appendChild(thumbCanvas);

    pdfDoc.getPage(i).then(page => {
      const viewport = page.getViewport({ scale: 0.15 });
      thumbCanvas.width = viewport.width;
      thumbCanvas.height = viewport.height;

      page.render({ canvasContext: thumbCtx, viewport }).promise.then(() => {
        thumbCanvas.addEventListener("click", () => {
          pageNum = i;
          renderPage(pageNum);
        });
      });
    });
  }
}

function highlightThumbnail(num) {
  thumbnailsContainer.querySelectorAll("canvas").forEach((c, i) => {
    c.classList.toggle("active", i + 1 === num);
  });
}

/* ===== UI UPDATE ===== */
function updateUI(num) {
  pageInfo.textContent = `Page ${num} of ${totalPages}`;
  prevBtn.disabled = num <= 1;
  nextBtn.disabled = num >= totalPages;
  highlightThumbnail(num);
}

/* ===== CONTROLS ===== */
prevBtn.onclick = () => { if (pageNum > 1) renderPage(--pageNum); };
nextBtn.onclick = () => { if (pageNum < totalPages) renderPage(++pageNum); };

// Close button now always redirects to course page
closeBtn.onclick = () => {
  window.location.href = courseUrl;
};

thumbLeft.onclick = () => thumbnailsContainer.scrollBy({ left: -200, behavior: "smooth" });
thumbRight.onclick = () => thumbnailsContainer.scrollBy({ left: 200, behavior: "smooth" });

/* ===== PROTECTION ===== */
canvas.addEventListener("contextmenu", e => e.preventDefault());
document.addEventListener("keydown", e => {
  if ((e.ctrlKey || e.metaKey) && ["s","p"].includes(e.key.toLowerCase())) e.preventDefault();
});
</script>

</body>
</html>