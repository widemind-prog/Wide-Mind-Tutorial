<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>PDF Viewer</title>
  <style>
    body {
      margin: 0;
      background: #111;
      color: #fff;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #controls {
      width: 100%;
      padding: 10px;
      background: #000;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    #closeBtn {
      position: absolute;
      right: 15px;
      top: 10px;
      background: transparent;
      color: #fff;
      font-size: 20px;
      border: none;
      cursor: pointer;
    }
    #closeBtn:hover { color: #ff4d4d; }
    button {
      padding: 6px 12px;
      border: none;
      cursor: pointer;
      background: #444;
      color: #fff;
    }
    button:disabled { opacity: 0.4; cursor: not-allowed; }
    canvas#pdfCanvas {
      margin: 20px auto;
      background: #fff;
    }
    #thumbnailsWrapper {
      display: flex;
      align-items: center;
      width: 95%;
      background: #222;
      padding: 10px;
      overflow: hidden;
      gap: 5px;
      position: relative;
    }
    #thumbnails {
      display: flex;
      overflow-x: auto;
      gap: 5px;
      scroll-behavior: smooth;
    }
    #thumbnails canvas {
      width: 60px;
      cursor: pointer;
      border: 2px solid #555;
      transition: border 0.2s;
      flex-shrink: 0;
    }
    #thumbnails canvas.active { border: 2px solid #ff4d4d; }
    .thumbArrow {
      font-size: 20px;
      background: #333;
      border: none;
      color: #fff;
      cursor: pointer;
      padding: 5px 10px;
      z-index: 5;
    }
    .thumbArrow:hover { background: #555; }
  </style>
</head>
<body>

<div id="controls">
  <button id="prevBtn">Previous</button>
  <span id="pageInfo">Page 1 of 1</span>
  <button id="nextBtn">Next</button>
  <button id="closeBtn" title="Close PDF">&times;</button>
</div>

<canvas id="pdfCanvas"></canvas>

<div id="thumbnailsWrapper">
  <button class="thumbArrow" id="thumbLeft">&#10094;</button>
  <div id="thumbnails"></div>
  <button class="thumbArrow" id="thumbRight">&#10095;</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
const pdfUrl = "/stream/pdf/{{ pdf_id }}";
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

let pdfDoc = null;
let pageNum = 1;
let totalPages = 0;
const pageCache = {}; // High-res cache

const canvas = document.getElementById("pdfCanvas");
const ctx = canvas.getContext("2d");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const pageInfo = document.getElementById("pageInfo");
const closeBtn = document.getElementById("closeBtn");
const thumbnailsContainer = document.getElementById("thumbnails");
const thumbLeft = document.getElementById("thumbLeft");
const thumbRight = document.getElementById("thumbRight");

// Load PDF
pdfjsLib.getDocument(pdfUrl).promise.then(pdf => {
  pdfDoc = pdf;
  totalPages = pdf.numPages;
  renderPage(pageNum);          // Render first page immediately
  createThumbnails();           // Render thumbnails in parallel
});

// Render high-res page
function renderPage(num) {
  if (pageCache[num]) {
    drawFromCache(pageCache[num]);
    return;
  }
  pdfDoc.getPage(num).then(page => {
    const viewport = page.getViewport({ scale: 1.5 });
    canvas.width = viewport.width;
    canvas.height = viewport.height;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    const renderTask = page.render({ canvasContext: ctx, viewport: viewport });
    renderTask.promise.then(() => {
      pageCache[num] = canvas.toDataURL(); // Cache rendered page
    });
    pageInfo.textContent = `Page ${num} of ${totalPages}`;
    prevBtn.disabled = num <= 1;
    nextBtn.disabled = num >= totalPages;
    highlightThumbnail(num);
    preloadAdjacentPages(num);
  });
}

// Draw from cache
function drawFromCache(dataURL) {
  const img = new Image();
  img.onload = () => ctx.drawImage(img, 0, 0);
  img.src = dataURL;
  pageInfo.textContent = `Page ${pageNum} of ${totalPages}`;
  prevBtn.disabled = pageNum <= 1;
  nextBtn.disabled = pageNum >= totalPages;
  highlightThumbnail(pageNum);
}

// Preload adjacent pages
function preloadAdjacentPages(current) {
  [current+1, current-1].forEach(n => {
    if (n>=1 && n<=totalPages && !pageCache[n]) {
      pdfDoc.getPage(n).then(page => {
        const viewport = page.getViewport({ scale: 1.5 });
        const tempCanvas = document.createElement("canvas");
        tempCanvas.width = viewport.width;
        tempCanvas.height = viewport.height;
        page.render({ canvasContext: tempCanvas.getContext("2d"), viewport: viewport })
          .promise.then(()=> pageCache[n] = tempCanvas.toDataURL());
      });
    }
  });
}

// Thumbnails
function createThumbnails() {
  for (let i=1;i<=totalPages;i++){
    const thumbCanvas = document.createElement("canvas");
    const thumbCtx = thumbCanvas.getContext("2d");
    thumbCanvas.width=100; thumbCanvas.height=130;
    thumbnailsContainer.appendChild(thumbCanvas);
    pdfDoc.getPage(i).then(page => {
      const viewport = page.getViewport({ scale: 0.15 });
      thumbCanvas.width = viewport.width;
      thumbCanvas.height = viewport.height;
      page.render({ canvasContext: thumbCtx, viewport: viewport }).promise.then(()=>{
        thumbCanvas.addEventListener("click", ()=> { pageNum=i; renderPage(pageNum); });
        thumbCanvas.addEventListener("mouseenter", ()=> { if(!pageCache[i]) renderPage(i); }); // hover preload
      });
    });
  }
}

// Highlight current thumbnail
function highlightThumbnail(num) {
  const thumbs = thumbnailsContainer.querySelectorAll("canvas");
  thumbs.forEach((thumb,index)=> thumb.classList.toggle("active", index+1===num));
}

// Scroll thumbnails
thumbLeft.addEventListener("click", ()=>{ thumbnailsContainer.scrollBy({left:-200,behavior:'smooth'}); });
thumbRight.addEventListener("click", ()=>{ thumbnailsContainer.scrollBy({left:200,behavior:'smooth'}); });

// Buttons
prevBtn.addEventListener("click", ()=>{ if(pageNum>1){ pageNum--; renderPage(pageNum); } });
nextBtn.addEventListener("click", ()=>{ if(pageNum<totalPages){ pageNum++; renderPage(pageNum); } });
closeBtn.addEventListener("click", ()=>{ window.history.back(); });

// Disable right-click & Ctrl+S
document.addEventListener("contextmenu", e=> e.preventDefault());
document.addEventListener("keydown", e=>{ if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==="s") e.preventDefault(); });
</script>

</body>
</html>