{% extends "base.html" %}
{% block content %}

<h2>{{ course.course_code }} - {{ course.course_title }}</h2>

{% if audio_id %}
<audio
  id="audioPlayer"
  controls
  controlsList="nodownload"
  src="/stream/audio/{{ audio_id }}">
</audio>
{% endif %}

{% if pdf_id %}
<button id="openPdfBtn" class="btn">Open PDF</button>
{% endif %}

<!-- PDF Modal -->
<div id="pdfModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:1000; overflow:auto;">
  <button id="closePdfModal" style="position:absolute; top:15px; right:20px; font-size:24px; background:none; border:none; color:white; cursor:pointer;">&times;</button>

  <div id="controls" style="text-align:center; margin-top:50px;">
    <button id="prevBtn">Previous</button>
    <span id="pageInfo">Page 1 of 1</span>
    <button id="nextBtn">Next</button>
  </div>

  <canvas id="pdfCanvas" style="display:block; margin:20px auto; background:#fff;"></canvas>

  <div id="thumbnailsWrapper" style="display:flex; justify-content:center; align-items:center; width:95%; background:#222; padding:10px; overflow:hidden; gap:5px; margin:20px auto;">
    <button class="thumbArrow" id="thumbLeft">&#10094;</button>
    <div id="thumbnails" style="display:flex; overflow-x:auto; gap:5px;"></div>
    <button class="thumbArrow" id="thumbRight">&#10095;</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
const pdfBtn = document.getElementById("openPdfBtn");
const pdfModal = document.getElementById("pdfModal");
const closePdf = document.getElementById("closePdfModal");

const pdfUrl = "/stream/pdf/{{ pdf_id }}";
pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

let pdfDoc = null, pageNum = 1, totalPages = 0;
const pageCache = {};
const canvas = document.getElementById("pdfCanvas");
const ctx = canvas.getContext("2d");
const prevBtn = document.getElementById("prevBtn");
const nextBtn = document.getElementById("nextBtn");
const pageInfo = document.getElementById("pageInfo");
const thumbnailsContainer = document.getElementById("thumbnails");
const thumbLeft = document.getElementById("thumbLeft");
const thumbRight = document.getElementById("thumbRight");

function renderPage(num) {
  if (pageCache[num]) { drawFromCache(pageCache[num]); return; }
  pdfDoc.getPage(num).then(page => {
    const viewport = page.getViewport({ scale: 1.5 });
    canvas.width = viewport.width;
    canvas.height = viewport.height;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    page.render({ canvasContext: ctx, viewport: viewport }).promise.then(() => {
      pageCache[num] = canvas.toDataURL();
    });
    pageInfo.textContent = `Page ${num} of ${totalPages}`;
    prevBtn.disabled = num <= 1;
    nextBtn.disabled = num >= totalPages;
    highlightThumbnail(num);
    preloadAdjacentPages(num);
  });
}

function drawFromCache(dataURL) {
  const img = new Image();
  img.onload = () => ctx.drawImage(img, 0, 0);
  img.src = dataURL;
  pageInfo.textContent = `Page ${pageNum} of ${totalPages}`;
  prevBtn.disabled = pageNum <= 1;
  nextBtn.disabled = pageNum >= totalPages;
  highlightThumbnail(pageNum);
}

function preloadAdjacentPages(current) {
  [current+1, current-1].forEach(n => {
    if (n>=1 && n<=totalPages && !pageCache[n]) {
      pdfDoc.getPage(n).then(page => {
        const viewport = page.getViewport({ scale: 1.5 });
        const tempCanvas = document.createElement("canvas");
        tempCanvas.width = viewport.width;
        tempCanvas.height = viewport.height;
        page.render({ canvasContext: tempCanvas.getContext("2d"), viewport: viewport })
          .promise.then(()=> pageCache[n] = tempCanvas.toDataURL());
      });
    }
  });
}

function createThumbnails() {
  for (let i=1;i<=totalPages;i++){
    const thumbCanvas = document.createElement("canvas");
    const thumbCtx = thumbCanvas.getContext("2d");
    thumbnailsContainer.appendChild(thumbCanvas);
    pdfDoc.getPage(i).then(page => {
      const viewport = page.getViewport({ scale: 0.15 });
      thumbCanvas.width = viewport.width;
      thumbCanvas.height = viewport.height;
      page.render({ canvasContext: thumbCtx, viewport: viewport }).promise.then(()=>{
        thumbCanvas.addEventListener("click", ()=> { pageNum=i; renderPage(pageNum); });
        thumbCanvas.addEventListener("mouseenter", ()=> { if(!pageCache[i]) renderPage(i); });
      });
    });
  }
}

function highlightThumbnail(num) {
  const thumbs = thumbnailsContainer.querySelectorAll("canvas");
  thumbs.forEach((thumb,index)=> thumb.classList.toggle("active", index+1===num));
}

pdfBtn.addEventListener("click", () => {
  pdfModal.style.display = "block";
  pdfjsLib.getDocument(pdfUrl).promise.then(pdf => {
    pdfDoc = pdf;
    totalPages = pdf.numPages;
    renderPage(pageNum);
    createThumbnails();
  });
});

closePdf.addEventListener("click", () => {
  pdfModal.style.display = "none";
  canvas.width = 0; canvas.height = 0;
  pageNum = 1;
  pdfDoc = null;
  thumbnailsContainer.innerHTML = "";
});

thumbLeft.addEventListener("click", ()=>{ thumbnailsContainer.scrollBy({left:-200,behavior:'smooth'}); });
thumbRight.addEventListener("click", ()=>{ thumbnailsContainer.scrollBy({left:200,behavior:'smooth'}); });
prevBtn.addEventListener("click", ()=>{ if(pageNum>1){ pageNum--; renderPage(pageNum); } });
nextBtn.addEventListener("click", ()=>{ if(pageNum<totalPages){ pageNum++; renderPage(pageNum); } });
</script>

<script src="/static/js/course.js"></script>
{% endblock %}